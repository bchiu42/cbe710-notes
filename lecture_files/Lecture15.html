

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Free energy perturbation &#8212; Notes for CBE710</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/defs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture_files/Lecture15';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    <p class="title logo__title">Notes for CBE710</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Class introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Statistical Mechanics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lecture1A.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture1B.html">Review of thermodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture2.html">Postulates of statistical mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture3.html">Application of the microcanonical ensemble: two-state system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problems/ps_1/problem_set_1.html">— Problem Set 1 —</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture4.html">Canonical Ensemble Continued</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture5.html">Generalized Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture6.html">The Ideal Gas Partition Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture7.html">The Langmuir Isotherm and Ising Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture8.html">The Ising Model and Mean-Field Theory</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lecture_files/Lecture15.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Free energy perturbation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-textbooks">Recommended textbooks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#topics-in-this-lecture">Topics in this lecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#umbrella-sampling">Umbrella sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Free energy perturbation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="free-energy-perturbation">
<h1>Free energy perturbation<a class="headerlink" href="#free-energy-perturbation" title="Permalink to this headline">#</a></h1>
<section id="recommended-textbooks">
<h2>Recommended textbooks<a class="headerlink" href="#recommended-textbooks" title="Permalink to this headline">#</a></h2>
<p>Frenkel and Smit Ch. 7</p>
</section>
<section id="topics-in-this-lecture">
<h2>Topics in this lecture<a class="headerlink" href="#topics-in-this-lecture" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Umbrella sampling</p></li>
<li><p>Free energy perturbation</p></li>
<li><p>Thermodynamic integration</p></li>
</ul>
</section>
<section id="umbrella-sampling">
<h2>Umbrella sampling<a class="headerlink" href="#umbrella-sampling" title="Permalink to this headline">#</a></h2>
<p>In the last lecture, we introduced the concept of the potential of mean
force, or the change in the Helmholtz free energy of the system as a
function of a reaction coordinate, <span class="math notranslate nohighlight">\(x(\mathbf{r}^N)\)</span>, that describes a
process of interest. The value of the PMF for some specific value of the
reaction coordinate, <span class="math notranslate nohighlight">\(x'\)</span>, is defined as:</p>
<div class="math notranslate nohighlight">
\[F(x') = -k_BT \ln Z(x') = -k_B T \ln \left [ p(x')  \right ] - k_B T \ln Z\]</div>
<p>Here, <span class="math notranslate nohighlight">\(Z\)</span> is the partition function of the entire system, which is
unknown, while <span class="math notranslate nohighlight">\(p(x')\)</span> is the unbiased probability that the system
obtains a configuration for which the reaction coordinate has a value
<span class="math notranslate nohighlight">\(x'\)</span>. We can write this probability distribution as:</p>
<div class="math notranslate nohighlight">
\[\label{app_a_partition_function_eq}
p(x') = \frac{\int d\mathbf{r}^N \exp \left [ -\beta  E(\mathbf{r}^N)\right  ]  \delta(x(\mathbf{r}^N) - x')}{Z}\]</div>
<p>The PMF is a very useful quantity for calculating equilibrium free
energy changes associated with processes that involve a well-defined
reaction coordinate. To calculate the PMF, however, the probability
associated with a specific value of the reaction coordinate, <span class="math notranslate nohighlight">\(p(x')\)</span>,
must be determined, which might be challenging for a system where
certain values of the reaction coordinate are observed with very low
probability. As a result, we began to describe an approach called
<strong>umbrella sampling</strong>, in which we apply some bias to the system
potential energy function that enforces sampling of particular values of
<span class="math notranslate nohighlight">\(x\)</span>. Then, we can relate the corresponding biased probability
distribution to the unbiased probability distribution to compute the
PMF. We specifically defined a weight function
<span class="math notranslate nohighlight">\(w_i(x) \equiv w_i[x(\textbf{r}^N)]\)</span> as the weight function that
restrains the system near some value of the reaction coordinate <span class="math notranslate nohighlight">\(x_i\)</span>.
Typically, this is defined as a harmonic potential of the form:</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
w_i(x) = \frac{1}{2} k(x-x_i)^2
\end{aligned}\]</div>
<p>The potential energy function of the system is then given by
<span class="math notranslate nohighlight">\(E(\mathbf{r}^N) + w_i(x)\)</span>, such that the weight function significantly
increases the energy of any configurations with values of the reaction
coordinate that differ significantly from the restrained value <span class="math notranslate nohighlight">\(x_i\)</span>. In
other words, we add a fictitious force (a spring force) that is not
meant to model a physical force in the system, but rather is added
solely to force the system to sample a particular value of the reaction
coordinate. Conceptually, the idea behind this is to effectively
“flatten” the free energy landscape by forcing the system to explore a
local region near <span class="math notranslate nohighlight">\(x_i\)</span>, thus allowing the sampling of values of <span class="math notranslate nohighlight">\(x_i\)</span>
that would not be explored in an unbiased simulation.</p>
<p><img alt="image" src="../_images/fig_14_4.png" />{width=”100%”}</p>
<p>We can now write the <strong>biased</strong> probability of finding the system at a
particular value of the reaction coordinate <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span> for
the <span class="math notranslate nohighlight">\(i\)</span>th simulation using the modified potential energy function:</p>
<div class="math notranslate nohighlight">
\[p_{\textrm{bias},i}(x') = \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} \delta(x(\mathbf{r}^N) - x')}{\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} }\]</div>
<p>The delta function selects only values of <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span>, so if
<span class="math notranslate nohighlight">\(x' \approx x_i\)</span>, then <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span> will be large;
otherwise, the weight function will lead to large values of the total
energy and thus negligible values of <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>. We can
sample this probability distribution directly in a simulation by adding
the weight function to the system dynamics (<em>i.e.</em>, adding a spring
force to relevant particles) to increase sampling of the value <span class="math notranslate nohighlight">\(x'=x_i\)</span>.
However, we need to sample the <strong>unbiased</strong> probability to calculate the
potential of mean force, so we need to relate <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>
to <span class="math notranslate nohighlight">\(p(x')\)</span>. To do so, we can first rewrite the biased probability
distribution as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} } \\
&amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{Z} \frac{Z} {\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} }
\end{aligned}\end{split}\]</div>
<p>By inspecting the second term we see that it is an integral over all
phase space of <span class="math notranslate nohighlight">\(e^{-\beta w_i(x)}\)</span> multiplied by a Boltzmann weight;
this is exactly the expression for the ensemble average
<span class="math notranslate nohighlight">\(\langle e^{-\beta w_i(x)} \rangle\)</span>, so we simplify to:</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{Z} \langle e^{-\beta w_i(x)} \rangle^{-1}
\end{aligned}\]</div>
<p>Next, we can recognize that the delta function in the integral selects
only those states for which <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span> (unlike the previous
ensemble average, where the integral includes all values of
<span class="math notranslate nohighlight">\(\mathbf{r}^N\)</span> and thus all values of <span class="math notranslate nohighlight">\(x(\mathbf{r}^N)\)</span>). As a result,
the value of the weight function can be computed analytically and
removed from the integral, yielding:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{e^{-\beta w_i(x')}\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]} \delta(x(\mathbf{r}^N) - x')}{Z} \langle e^{-\beta w_i(x)} \rangle^{-1}\\
&amp;= e^{-\beta w_i(x')} p(x') \langle e^{-\beta w_i(x)} \rangle^{-1}
\end{aligned}\end{split}\]</div>
<p>Note that we are being careful to distinguish between the value of the
weight function for a specific value of the reaction coordinate,
<span class="math notranslate nohighlight">\(e^{-\beta w_i(x')}\)</span>, which is analytically defined, and the
ensemble-average value of the weight function for all possible values of
the reaction coordinate, <span class="math notranslate nohighlight">\(\langle e^{-\beta w_i(x)} \rangle\)</span>, which will
depend on the entire phase space. We can then rearrange this expression
for the unbiased probability to write:</p>
<div class="math notranslate nohighlight">
\[\label{app_a_us_unbiased_prob}
p(x') = e^{\beta w_i(x')} p_{\textrm{bias}, i}(x') \langle e^{-\beta w_i(x)} \rangle\]</div>
<p>This expression thus relates the biased probability distribution from
the <span class="math notranslate nohighlight">\(i\)</span>th biased simulation to the unbiased probability distribution. We
can then write the value of the PMF, <span class="math notranslate nohighlight">\(F_i(x')\)</span> associated with <span class="math notranslate nohighlight">\(x'\)</span>
based on the <span class="math notranslate nohighlight">\(i\)</span>th simulation (i.e., the simulation with a bias applied
to <span class="math notranslate nohighlight">\(x_i\)</span>) as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
F_i(x') &amp;= -k_BT \ln \left [ p(x') \right ] - k_BT \ln Z \\ 
&amp;= -k_BT \ln \left [   e^{\beta w_i(x')} p_{\textrm{bias}, i}(x') \langle e^{-\beta w_i(x)} \rangle \right ] - k_BT \ln Z\\
&amp;= -k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ] - w_i(x') - k_BT \ln \langle \exp \left [ -\beta w_i(x) \right ] \rangle  - k_BT \ln Z \label{app_a_us_nofi_eq}
\end{aligned}\end{split}\]</div>
<p>Let’s consider each of these terms in turn. The first term,
<span class="math notranslate nohighlight">\(-k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ]\)</span>, can be estimated
directly from the <span class="math notranslate nohighlight">\(i\)</span>th biased molecular simulation for which the weight
function will restrain the simulation to sample configurations with
<span class="math notranslate nohighlight">\(x(\mathbf{r}^N) \approx x_i'\)</span>, allowing <span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> to
be calculated even if <span class="math notranslate nohighlight">\(x'\)</span> is normally not sampled in an unbiased
simulation. The second term, <span class="math notranslate nohighlight">\(w_i(x')\)</span>, is calculated analytically since
the expression for the weight function is specified. The fourth term,
<span class="math notranslate nohighlight">\(-k_BT \ln Z\)</span>, is a constant that does not depend on <span class="math notranslate nohighlight">\(x'\)</span> and can be
eliminated by only consider differences in the PMF. Finally, the third
term, <span class="math notranslate nohighlight">\(- k_BT \ln \langle \exp \left [ -\beta w_i(x) \right ] \rangle\)</span>
is the ensemble average of the exponential weight function for <span class="math notranslate nohighlight">\(x'\)</span>
sampled from the unbiased ensemble. As we will show below, this term is
equal to the free energy cost associated with introducing the weight
function. We can define this term as <span class="math notranslate nohighlight">\(K_i\)</span> to write our final expression
as:</p>
<div class="math notranslate nohighlight">
\[\label{app_a_pmf_final_eq}
F_i(x') = -k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ] - w_i(x') +     K_i  - k_BT \ln Z\]</div>
<p>This final expression is a powerful approach for computing values of the
PMF as follows. We first define a set of harmonic weight functions, each
centered on some value <span class="math notranslate nohighlight">\(x_i\)</span> such that the total set of restrained
values spans the values of <span class="math notranslate nohighlight">\(x\)</span> that are of interest. An independent
simulation is then performed for each value of <span class="math notranslate nohighlight">\(x_i\)</span> and
<span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> is estimated for all <span class="math notranslate nohighlight">\(x'\)</span> (typically by
histogramming). The unbiased PMF for <span class="math notranslate nohighlight">\(x'\)</span> is then computed from the
<span class="math notranslate nohighlight">\(i\)</span>th simulation using the expression above. By only considering
differences in the PMF, the <span class="math notranslate nohighlight">\(- k_BT \ln Z\)</span> term drops out, leaving only
the set of <span class="math notranslate nohighlight">\(K_i\)</span> to be determined for the entire PMF to be specified.
However, we can compute the set of <span class="math notranslate nohighlight">\(K_i\)</span> by recognizing that the value
of the unbiased PMF, <span class="math notranslate nohighlight">\(F_i(x')\)</span>, should be independent of the value of
<span class="math notranslate nohighlight">\(x_i\)</span> that is biased. Thus, we can compute <span class="math notranslate nohighlight">\(F_i(x')\)</span> for the same <span class="math notranslate nohighlight">\(x'\)</span>
from several different biased simulations (i.e. different biased values
of <span class="math notranslate nohighlight">\(x_i\)</span>) and adjust the values of <span class="math notranslate nohighlight">\(K_i\)</span> such that the estimate for
<span class="math notranslate nohighlight">\(F(x')\)</span> matches across all biased windows. This approach requires that
the biased simulations <strong>overlap</strong> - that is, that there is a
non-negligible value of <span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> for the same value of
<span class="math notranslate nohighlight">\(x'\)</span> sampled in each of the overlapping windows. In practice, this means
that the harmonic weight function must allow the system to sample
configurations slightly different from <span class="math notranslate nohighlight">\(x_i\)</span> to ensure that <span class="math notranslate nohighlight">\(x'\)</span> can be
sampled in multiple different biased simulations.</p>
<p><img alt="image" src="../_images/fig_15_1.png" />{width=”100%”}</p>
<p>So, to recap: umbrella sampling allows us to calculate the PMF (i.e. the
change in the free energy) associated with any arbitrary process by
sampling configurations associated with different values of a reaction
coordinate associated with the process. The key advantage of the
umbrella sampling approach is that any value of the reaction coordiante
can be sampled by applying weight functions, thus enabling the estimate
of the PMF even for very low probability (high free energy) states. From
a computational standpoint, this method requires a series of independent
simulations to be performed and then free energies to be determined by
matching estimates of the PMF from overlapping biased simulations. The
requirement of overlap renders this technique inefficient
computationally, although more efficient methods (such as the Weighted
Histogram Analysis Method) have been developed to compute the set of
<span class="math notranslate nohighlight">\(K_i\)</span>. These techniques are outside the scope of this discussion.
Umbrella sampling is very commonly used to compute PMFs for processes
with large energy barriers, such that the processes cannot be directly
observed in unbiased simulations. For example, one could apply umbrella
sampling to calculate the free energy change associated with adsorbing a
molecule to a surface by defining the distance to the surface as the
reaction coordinate, choosing multiple values of this distance, then
performing multiple independent simulations in which the molecule of
interest is restrained to each value of the reaction coordinate using a
harmonic spring.</p>
</section>
<section id="id1">
<h2>Free energy perturbation<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>So far, we have defined the potential of mean force as the change in the
free energy of a system during a process in which particle coordinates
follow some predefined reaction coordinate, and hence the overall system
potential energy function is unchanged. Computing the potential of mean
force associated with different regions of phase space is useful for
calculating the magnitude of energy barriers and identifying local
minima. However, we might also ask how to calculate the change in free
energy between two systems with different potential energy functions
entirely. Finding an algorithm to accomplish this would also be useful
in applications other than calculating a PMF along a reaction
coordinate, such as calculating the free energy change associated with
mutating the chemical identities of molecules in a simulation. We can
compute the free energy difference between two systems with different
partition functions using a technique called <strong>free energy
perturbation</strong>.</p>
<p>For this calculation, we will first define two partition functions,
<span class="math notranslate nohighlight">\(Z_0\)</span> and <span class="math notranslate nohighlight">\(Z_1\)</span>, corresponding to two different systems with potential
energy functions <span class="math notranslate nohighlight">\(E_0(\mathbf{r}^N)\)</span> and <span class="math notranslate nohighlight">\(E_1(\mathbf{r}^N)\)</span>. Note that
while the potential energy functions are different, we assume that the
set of possible values of <span class="math notranslate nohighlight">\(\mathbf{r}^N\)</span> are the same (<em>i.e.</em>, both
systems access the same phase space). For example, one could imagine
computing the free energy difference between an ideal gas and a
non-ideal gas with the same number of particles, with the interactions
associated with the non-ideal gas leading to a different potential
energy function. The Helmholtz free energy change for transforming from
system 0 to 1 is then:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\Delta F &amp;= F_1 - F_0  \\ 
&amp;= -k_BT \ln Z_1/Z_0 \\
&amp;= -k_BT \ln \left [ \frac{\int d\mathbf{r}^N \exp \left [ -\beta  E_1(\mathbf{r}^N)\right ]}{\int d\mathbf{r}^N \exp \left [ -\beta  E_0(\mathbf{r}^N)\right ]} \right ]
\end{aligned}\end{split}\]</div>
<p>Next, we define <span class="math notranslate nohighlight">\(p_1(\Delta E')\)</span> as the probability distribution for the
energy difference
<span class="math notranslate nohighlight">\(\Delta E(\textbf{r}^N) = E_1(\mathbf{r}^N) - E_0(\mathbf{r}^N)\)</span> with
configurations sampled using <span class="math notranslate nohighlight">\(E_1\)</span>. In other words, we can imagine
generating a large number of configurations using the potential energy
function for system 1, calculating the energy of those configurations
according to both <span class="math notranslate nohighlight">\(E_1\)</span> and <span class="math notranslate nohighlight">\(E_0\)</span>, then finding the probability of
identifying a particular energy difference <span class="math notranslate nohighlight">\(\Delta E'\)</span>. Similarly,
<span class="math notranslate nohighlight">\(p_0(\Delta E')\)</span> is the probability density for the same energy
difference with configurations sampled using <span class="math notranslate nohighlight">\(E_0\)</span>. We then write:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_1(\Delta E') &amp;= \frac{\int d\mathbf{r}^N \exp \left [ -\beta E_1(\mathbf{r}^N) \right ] \delta(\Delta E(\textbf{r}^N) - \Delta E')}{Z_1}  \\
&amp;= \frac{\int d\mathbf{r}^N \exp \left [ -\beta (E_0(\mathbf{r}^N) + \Delta E') \right ] \delta(\Delta E(\textbf{r}^N) - \Delta E')}{Z_1}  \\
&amp;= \frac{\int d\mathbf{r}^N \exp \left [ -\beta E_0(\mathbf{r}^N) \right ] \exp \left [ -\beta \Delta E' \right ] \delta(\Delta E(\textbf{r}^N) - \Delta E')}{Z_1}
\end{aligned}\end{split}\]</div>
<p>Here, <span class="math notranslate nohighlight">\(\Delta E'\)</span> is a fixed value that is not a function of
<span class="math notranslate nohighlight">\(\mathbf{r}^N\)</span> and the delta function eliminates all other possible
values of <span class="math notranslate nohighlight">\(\Delta E(\textbf{r}^N)\)</span>, so in the second line we can define
<span class="math notranslate nohighlight">\(E_1(\textbf{r}^N) = E_0(\textbf{r}^N) + \Delta E'\)</span> and in the third
line <span class="math notranslate nohighlight">\(\exp \left [ -\beta \Delta E' \right ]\)</span> can be removed from the
integral. We can now multiply the numerator and demoninator by <span class="math notranslate nohighlight">\(Z_0\)</span> to
obtain:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_1(\Delta E') &amp;= \exp \left [ -\beta \Delta E' \right ] \frac{\int d\mathbf{r}^N \exp \left [ -\beta E_0(\mathbf{r}^N) \right ]  \delta(\Delta E(\textbf{r}^N) - \Delta E')}{Z_1}   \\
&amp;= \frac{Z_0}{Z_1} \exp \left [ -\beta \Delta E' \right ] \frac{\int d\mathbf{r}^N \exp \left [ -\beta E_0(\mathbf{r}^N) \right ]  \delta(\Delta E(\textbf{r}^N) - \Delta E')}{Z_0}   \\
&amp;= \frac{Z_0}{Z_1} \exp \left [ -\beta \Delta E' \right ] p_0(\Delta E')
\end{aligned}\end{split}\]</div>
<p>We can take the log of both sides to estimate the free energy difference
using <span class="math notranslate nohighlight">\(\Delta F = -kT \ln Z_1/Z_0\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\ln p_1(\Delta E') &amp;= \ln \left [ Z_0 / Z_1 \right ] - \beta \Delta E' + \ln p_0 (\Delta E')   \\
&amp;= \beta \Delta F - \beta \Delta E' + \ln p_0 (\Delta E') \\
&amp;= \beta (\Delta F - \Delta E') + \ln p_0 (\Delta E') \\
\therefore p_1(\Delta E')&amp;= p_0 (\Delta E') \exp \left [\beta \left ( \Delta F - \Delta E'\right )\right ]
\end{aligned}\end{split}\]</div>
<p>From this equation alone we can see that calculating the two probability
densities from simulations in both ensembles would allow for the
calculation of the free energy change <span class="math notranslate nohighlight">\(\Delta F\)</span>. Finally, we can
integrate both sides over all possible values of <span class="math notranslate nohighlight">\(\Delta E'\)</span> to yield a
more concise expression:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\int_{-\infty}^{\infty} d\Delta E' p_1(\Delta E') &amp;= \exp (\beta \Delta F)\int_{-\infty}^{\infty} d\Delta E' p_0(\Delta E') \exp (-\beta \Delta E')\\
1 &amp;= \exp (\beta \Delta F) \langle \exp \left [ - \beta \Delta E \right ] \rangle_0\\
\exp \left [ -\beta \Delta F \right ]  &amp;= \langle \exp \left [ - \beta \Delta E \right ] \rangle_0 \label{app_a_fep_eq}
\end{aligned}\end{split}\]</div>
<p>Here, we integrate the probability distribution for <span class="math notranslate nohighlight">\(\Delta E'\)</span> over all
possible energy differences sampled in system 1; since the probability
distributions is normalized, this just equals 1. The value <span class="math notranslate nohighlight">\(\Delta F\)</span> is
independent of <span class="math notranslate nohighlight">\(\Delta E'\)</span> so it can be removed from the integral on the
right hand side, which then is equal to the ensemble average value of
the exponential of <span class="math notranslate nohighlight">\(\Delta E'\)</span>, yielding the final expression. Note
again that this ensemble average is sampled using the energy function of
system 0.</p>
<p>The final free energy perturbation expression relates the free energy
change for transforming from system 0 to system 1 to the ensemble
average of the energy change for this transformation for configurations
sampled from <span class="math notranslate nohighlight">\(Z_0\)</span>. Free energy perturbation can be used directly in
molecular simulations by defining system 0 and 1, generating
configurations according to the potential energy function of system 0,
calculating the energy of the same configuration calculated using both
<span class="math notranslate nohighlight">\(E_1\)</span> and <span class="math notranslate nohighlight">\(E_0\)</span>, then averaging <span class="math notranslate nohighlight">\(E_1 - E_0\)</span> to get <span class="math notranslate nohighlight">\(\Delta F\)</span> according
to eq. <span class="xref myst">[app_a_fep_eq]</span>{reference-type=”eqref”
reference=”app_a_fep_eq”}. Note that there are <em>no</em> constraints on what
the potential energy functions of system <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(1\)</span> can be, so it is
possible to use this approach to completely change the chemical identify
of molecules during a simulation and measure the corresponding free
energy change. Such transformations are called <em>alchemical free energy
calculations</em>.</p>
<p>Alchemical free energy calculations are often used to compute the free
energy difference between two states that have no clear reaction
coordinate connecting them, and for which only differences in energy
(and not complete free energy pathways) are necessary. A typical example
is in the design of drug inhibitors to bind proteins - free energy
perturbation can be used to calculate the free energy change between a
molecule bound to a receptor and a slightly different molecule bound to
the same receptor to quantify relative binding affinities.
Alternatively, the same technique could be used to calculate the
absolute free energy of binding by defining a difference in free energy
between the bound drug molecule and a drug molecule free in solution.</p>
<p><img alt="image" src="../_images/fig_15_2.png" />{width=”100%”}</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lecture_files"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-textbooks">Recommended textbooks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#topics-in-this-lecture">Topics in this lecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#umbrella-sampling">Umbrella sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Free energy perturbation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Reid van Lehn, Matt Gebbie, Rose Cersonsky
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>